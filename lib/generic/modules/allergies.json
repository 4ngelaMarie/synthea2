{
  "name": "Allergies and Treatment",
  "remarks": [
    "This module onsets allergies and manages the treatment of allergies and ",
    "allergic diseases. After the initial series of AllergyOnset states, the ",
    "module waits for an allergic condition (as a result of a person's allergies)",
    "to prompt treatment.",

    "Primary reference for allergy statistics: ",
    "https://web.archive.org/web/20100407195412/http://www.niaid.nih.gov/topics/foodAllergy/understanding/Pages/quickFacts.aspx"
  ],
  "states": {

    "Initial": {
      "type": "Initial",
      "direct_transition": "Delay_For_Atopy"
    },

    "Delay_For_Atopy": {
      "type": "Delay",
      "remarks": [
        "The Atopy module must be processed before any of the allergy modules so ",
        "atopy can appropriately influence allergies. Delaying the smallest possible ",
        "time step to ensure this happens."
      ],
      "exact": {
        "quantity": 1,
        "unit": "weeks"
      },
      "direct_transition": "Chance_of_Peanut_Allergy"
    },

    "Chance_of_Peanut_Allergy": {
      "type": "Simple",
      "remarks": [
        "Allergy to peanuts and tree nuts in the general population is, respectively, 0.6 percent and 0.4 percent, ",
        "with the rate in children under age 18 (0.8 percent and 0.2 percent) slightly different from adults (0.6 percent and 0.5 percent respectively). "
      ],
      "complex_transition": [
        {
          "condition": {
            "condition_type": "Attribute",
            "attribute": "atopic",
            "operator": "is not nil"
          },
          "distributions": [
            {
              "distribution": 0.25,
              "transition": "Peanut_Allergy"
            },
            {
              "distribution": 0.75,
              "transition": "Chance_of_TreeNut_Allergy"
            }
          ]
        },
        {
          "distributions": [
            {
              "distribution": 0.006,
              "transition": "Peanut_Allergy"
            },
            {
              "distribution": 0.994,
              "transition": "Chance_of_TreeNut_Allergy"
            }
          ]
        }
      ]
    },

    "Peanut_Allergy": {
      "type": "AllergyOnset",
      "target_encounter": "Allergist_Initial_Visit",
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "91935009",
          "display": "Allergy to peanuts"
        }
      ],
      "direct_transition": "Chance_of_TreeNut_Allergy"
    },

    "Chance_of_TreeNut_Allergy": {
      "type": "Simple",
      "remarks": [
        "Allergy to peanuts and tree nuts in the general population is, respectively, 0.6 percent and 0.4 percent, ",
        "with the rate in children under age 18 (0.8 percent and 0.2 percent) slightly different from adults (0.6 percent and 0.5 percent respectively). "
      ],
      "complex_transition": [
        {
          "condition": {
            "condition_type": "Attribute",
            "attribute": "atopic",
            "operator": "is not nil"
          },
          "distributions": [
            {
              "distribution": 0.25,
              "transition": "TreeNut_Allergy"
            },
            {
              "distribution": 0.75,
              "transition": "Chance_of_Fish_Allergy"
            }
          ]
        },
        {
          "distributions": [
            {
              "distribution": 0.004,
              "transition": "TreeNut_Allergy"
            },
            {
              "distribution": 0.996,
              "transition": "Chance_of_Fish_Allergy"
            }
          ]
        }
      ]
    },

    "TreeNut_Allergy": {
      "type": "AllergyOnset",
      "target_encounter": "Allergist_Initial_Visit",
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "91934008",
          "display": "Allergy to nut"
        }
      ],
      "direct_transition": "Chance_of_Fish_Allergy"
    },

    "Chance_of_Fish_Allergy": {
      "type": "Simple",
      "remarks": [
        "The prevalence of seafood allergy in the general population is 0.4 percent to fish, 2.0 percent to shellfish and 0.2 percent to both.",
        "Seafood allergy is less common in children (0.6 percent) than adults (2.8 percent). "
      ],
      "complex_transition": [
        {
          "condition": {
            "condition_type": "Attribute",
            "attribute": "atopic",
            "operator": "is not nil"
          },
          "distributions": [
            {
              "distribution": 0.25,
              "transition": "Fish_Allergy"
            },
            {
              "distribution": 0.75,
              "transition": "Chance_of_Shellfish_Allergy"
            }
          ]
        },
        {
          "distributions": [
            {
              "distribution": 0.004,
              "transition": "Fish_Allergy"
            },
            {
              "distribution": 0.996,
              "transition": "Chance_of_Shellfish_Allergy"
            }
          ]
        }
      ]
    },

    "Fish_Allergy": {
      "type": "AllergyOnset",
      "target_encounter": "Allergist_Initial_Visit",
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "417532002",
          "display": "Allergy to fish"
        }
      ],
      "direct_transition": "Chance_of_Shellfish_Allergy"
    },

    "Chance_of_Shellfish_Allergy": {
      "type": "Simple",
      "remarks": [
        "The prevalence of seafood allergy in the general population is 0.4 percent to fish, 2.0 percent to shellfish and 0.2 percent to both.",
        "Seafood allergy is less common in children (0.6 percent) than adults (2.8 percent). "
      ],
      "complex_transition": [
        {
          "condition": {
            "condition_type": "Attribute",
            "attribute": "atopic",
            "operator": "is not nil"
          },
          "distributions": [
            {
              "distribution": 0.25,
              "transition": "Shellfish_Allergy"
            },
            {
              "distribution": 0.75,
              "transition": "Chance_of_Wheat_Allergy"
            }
          ]
        },
        {
          "distributions": [
            {
              "distribution": 0.02,
              "transition": "Shellfish_Allergy"
            },
            {
              "distribution": 0.98,
              "transition": "Chance_of_Wheat_Allergy"
            }
          ]
        }
      ]
    },

    "Shellfish_Allergy": {
      "type": "AllergyOnset",
      "target_encounter": "Allergist_Initial_Visit",
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "300913006",
          "display": "Shellfish allergy"
        }
      ],

      "direct_transition": "Chance_of_Wheat_Allergy"
    },

    "Chance_of_Wheat_Allergy": {
      "type": "Simple",
      "remarks": [
        "Wheat allergy is different than celiac disease. There are few studies on prevalence of wheat allergy.",
        "A recent study 0.4% of US adults reported an allergy to wheat diagnosed via a doctor [6]. The prevalence ",
        "of wheat allergy is highest amongst children in the US, ranging from 0.4% to 1.0% of the population.",
        "http://www.drschaer-institute.com/us/wheat-allergy/epidemiology-1043.html",

        "Wheat allergy is typically outgrown by adulthood â€” about 65 percent of children with a wheat allergy ",
        "will outgrow it by the time they are 12. Based on prevalences we assume that adult onset of ",
        "the allergy is rare enough to ignore."
      ],
      "complex_transition": [
        {
          "condition": {
            "condition_type": "Attribute",
            "attribute": "atopic",
            "operator": "is not nil"
          },
          "distributions": [
            {
              "distribution": 0.25,
              "transition": "Wheat_Allergy"
            },
            {
              "distribution": 0.75,
              "transition": "Chance_of_Eggs_Allergy"
            }
          ]
        },
        {
          "distributions": [
            {
              "distribution": 0.006,
              "transition": "Wheat_Allergy"
            },
            {
              "distribution": 0.994,
              "transition": "Chance_of_Eggs_Allergy"
            }
          ]
        }
      ]
    },

    "Wheat_Allergy": {
      "type": "AllergyOnset",
      "target_encounter": "Allergist_Initial_Visit",
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "420174000",
          "display": "Allergy to wheat"
        }
      ],
      "direct_transition": "Chance_of_Eggs_Allergy"
    },

    "Chance_of_Eggs_Allergy": {
      "type": "Simple",
      "remarks": [
        "Experts estimate that as many as 2 percent of children are allergic to eggs. ",
        "Fortunately, studies show that about 70 percent of children with an egg allergy ",
        "will outgrow the condition by age 16.",

        "http://acaai.org/allergies/types/food-allergies/types-food-allergy/egg-allergy",
        "Based on prevalences we assume that adult onset of the allergy is rare enough to ignore."
      ],
      "complex_transition": [
        {
          "condition": {
            "condition_type": "Attribute",
            "attribute": "atopic",
            "operator": "is not nil"
          },
          "distributions": [
            {
              "distribution": 0.25,
              "transition": "Eggs_Allergy"
            },
            {
              "distribution": 0.75,
              "transition": "Chance_of_Dairy_Allergy"
            }
          ]
        },
        {
          "distributions": [
            {
              "distribution": 0.006,
              "transition": "Eggs_Allergy"
            },
            {
              "distribution": 0.994,
              "transition": "Chance_of_Dairy_Allergy"
            }
          ]
        }
      ]
    },

    "Eggs_Allergy": {
      "type": "AllergyOnset",
      "target_encounter": "Allergist_Initial_Visit",
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "91930004",
          "display": "Allergy to eggs"
        }
      ],
      "direct_transition": "Chance_of_Dairy_Allergy"
    },

    "Chance_of_Dairy_Allergy": {
      "type": "Simple",
      "remarks": [
        "The prevalence of dairy/milk allergy in the general population is 1-2% for young ",
        "children and 0.2-0.4% in the general population. About 80 percent of children are ",
        "likely to outgrow their milk allergy before they are 16. Based on prevalences we ",
        "assume that adult onset of the allergy is rare enough to ignore."
      ],
      "complex_transition": [
        {
          "condition": {
            "condition_type": "Attribute",
            "attribute": "atopic",
            "operator": "is not nil"
          },
          "distributions": [
            {
              "distribution": 0.25,
              "transition": "Dairy_Allergy"
            },
            {
              "distribution": 0.75,
              "transition": "Living_With_Allergies"
            }
          ]
        },
        {
          "distributions": [
            {
              "distribution": 0.0015,
              "transition": "Dairy_Allergy"
            },
            {
              "distribution": 0.9985,
              "transition": "Living_With_Allergies"
            }
          ]
        }
      ]
    },

    "Dairy_Allergy": {
      "type": "AllergyOnset",
      "target_encounter": "Allergist_Initial_Visit",
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "425525006",
          "display": "Allergy to dairy product"
        }
      ],
      "direct_transition": "Living_With_Allergies"
    },

    "Living_With_Allergies": {
      "type": "Simple",
      "remarks": [
        "Whatever allergies the patients have they will continue to passively ",
        "live with them until an allergic condition or a severe reaction ",
        "prompts a visit to their PCP and a referral to an allergist. Allergies ",
        "aren't officially diagnosed until after an allergy test is performed."
      ],
      "direct_transition": "Immunotherapy_Guard"
    },

    "Immunotherapy_Guard": {
      "type": "Guard",
      "allow": {
        "condition_type": "And",
        "conditions": [
          {
            "condition_type": "Age",
            "operator": ">=",
            "quantity": 12,
            "unit": "years",
            "remarks": [
              "They typically don't give immunotherapy treatment to young children"
            ]
          },
          {
            "condition_type": "Attribute",
            "attribute": "immunotherapy_status",
            "operator": "is nil"
          }
        ]
      },
      "direct_transition": "Delay_For_Consultation"
    },

    "Delay_For_Consultation": {
      "type": "Delay",
      "remarks": [
        "This state is used to stagger the age that patient's consider/begin ",
        "immunotherapy treatment. Patients can now begin receiving treatment ",
        "between age 12 and age 17."
      ],
      "range": {
        "low": 0,
        "high": 5,
        "unit": "years"
      },
      "direct_transition": "Immunotherapy_Consultation"
    },

    "Immunotherapy_Consultation": {
      "type": "Encounter",
      "encounter_class": "ambulatory",
      "reason": "allergic_rhinitis",
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "170837001",
          "display": "Allergic disorder initial assessment"
        }
      ],
      "distributed_transition": [
        {
          "distribution": 0.75,
          "transition": "Immunotherapy_Given"
        },
        {
          "distribution": 0.25,
          "transition": "Immunotherapy_Not_Given",
          "remarks": [
            "The distribution here is somewhat arbitrary. I could not find reasonable stats for",
            "what percentage of people are given immunotherapy but it's not everyone.",
            "I went with a 75/25 split. Reasons to not give immunotherapy include fear of needles,",
            "pre-existing immune conditions (like AIDS), and prohibitive cost."
          ]
        }
      ]
    },

    "Immunotherapy_Given": {
      "type": "SetAttribute",
      "attribute": "immunotherapy_status",
      "value": "given",
      "direct_transition": "Immunotherapy_CarePlan"
    },

    "Immunotherapy_Not_Given": {
      "type": "EncounterEnd",
      "direct_transition": "Terminal"
    },

    "Immunotherapy_CarePlan": {
      "type": "CarePlanStart",
      "target_encounter": "Immunotherapy_Consultation",
      "reason": "allergic_rhinitis",
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "170836005",
          "display": "Allergic disorder monitoring"
        }
      ],
      "activities": [
        {
          "system": "SNOMED-CT",
          "code": "764101000000108",
          "display": "Allergen immunotherapy drugs Band 1"
        }
      ],
      "direct_transition": "Allergy_Screening_Test"
    },

    "Allergy_Screening_Test": {
      "type": "Procedure",
      "target_encounter": "Immunotherapy_Consultation",
      "reason": "allergic_rhinitis",
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "395142003",
          "display": "Allergy screening test"
        }
      ],
      "duration" : { "low" : 30, "high" : 60, "unit" : "minutes" },
      "remarks" : ["Skin testing is fast. For both types of skin tests, positive reactions usually appear within 20 minutes.",
                   "http://acaai.org/allergies/treatment/allergy-testing"],
      "direct_transition": "End_Consultation"
    },

    "End_Consultation" : {
      "type" : "EncounterEnd",
      "direct_transition" : "Initialize_Immunotherapy_Counter"
    },

    "Initialize_Immunotherapy_Counter": {
      "type": "SetAttribute",
      "attribute": "immunotherapy_counter",
      "value": 0,
      "direct_transition": "Undergoing_Immunotherapy_Treatment"
    },

    "Undergoing_Immunotherapy_Treatment": {
      "type": "Delay",
      "remarks": [
        "Patients get immunotherapy treatments for an average of 5 years.",
        "Given monthly appointments we count a total of 60 appointments before ",
        "ending the immunotherapy."
      ],
      "range": {
        "low": 3,
        "high": 4,
        "unit": "weeks"
      },
      "conditional_transition": [
        {
          "condition": {
            "condition_type": "Attribute",
            "attribute": "immunotherapy_counter",
            "operator": "<",
            "value": 60
          },
          "transition": "Immunotherapy_Treatment"
        },
        {
          "transition": "Immunotherapy_Treatment_Complete"
        }
      ]
    },

    "Immunotherapy_Treatment": {
      "type": "Encounter",
      "encounter_class": "ambulatory",
      "reason": "allergic_rhinitis",
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "371883000",
          "display": "Outpatient procedure"
        }
      ],
      "direct_transition": "Immunotherapy_Procedure"
    },

    "Immunotherapy_Procedure": {
      "type": "Procedure",
      "target_encounter": "Immunotherapy_Treatment",
      "reason": "allergic_rhinitis",
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "180256009",
          "display": "Subcutaneous immunotherapy"
        }
      ],
      "duration" : { "low" : 15, "high" : 60, "unit" : "minutes" },
      "direct_transition": "End_Treatment_Session"
    },

    "End_Treatment_Session" : {
      "type" : "EncounterEnd",
      "direct_transition": "Count_A_Treatment"
    },

    "Count_A_Treatment": {
      "type": "Counter",
      "action": "increment",
      "attribute": "immunotherapy_counter",
      "direct_transition": "Undergoing_Immunotherapy_Treatment"
    },

    "Immunotherapy_Treatment_Complete": {
      "type": "Simple",
      "direct_transition": "Immunotherapy_Followup"
    },

    "Immunotherapy_Followup": {
      "type": "Encounter",
      "encounter_class": "ambulatory",
      "reason": "allergic_rhinitis",
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "170838006",
          "display": "Allergic disorder follow-up assessment"
        }
      ],
      "direct_transition": "Immunotherapy_CarePlan_Ends"
    },

    "Immunotherapy_CarePlan_Ends": {
      "type": "CarePlanEnd",
      "careplan": "Immunotherapy_CarePlan",
      "direct_transition": "Followup_End"
    },

    "Followup_End" : {
      "type" : "EncounterEnd",
      "direct_transition": "Terminal"
    },

    "Terminal": {
      "type": "Terminal"
    }
  }
}

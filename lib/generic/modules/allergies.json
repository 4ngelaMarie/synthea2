{
  "name": "Allergies and Treatment",
  "remarks": [
    "This module onsets allergies and manages the treatment of allergies and ",
    "allergic diseases. After the initial series of AllergyOnset states, the ",
    "module waits for an allergic condition (as a result of a person's allergies)",
    "to prompt treatment.",

    "Primary reference for allergy statistics: ",
    "https://web.archive.org/web/20100407195412/http://www.niaid.nih.gov/topics/foodAllergy/understanding/Pages/quickFacts.aspx"
  ],
  "states": {

    "Initial": {
      "type": "Initial",
      "direct_transition": "Delay_For_Atopy"
    },

    "Delay_For_Atopy": {
      "type": "Delay",
      "remarks": [
        "The Atopy module must be processed before any of the allergy modules so ",
        "atopy can appropriately influence allergies. Delaying the smallest possible ",
        "time step to ensure this happens."
      ],
      "exact": {
        "quantity": 1,
        "unit": "weeks"
      },
      "direct_transition": "Allergy_Incidence_Submodule"
    },

    "Allergy_Incidence_Submodule": {
      "type": "CallSubmodule",
      "remarks": [
        "This submodule onsets the various food and environmental allergies that ",
        "a person can get, with different incidences for atopic and non-atopic ",
        "patients."
      ],
      "submodule": "allergies/allergy_incidence",
      "direct_transition": "Allergist_Guard"
    },

    "Allergist_Guard": {
      "type": "Guard",
      "remarks": [
        "======================================================================",
        " ALLERGY TREATMENT/CARE                                               ",
        "======================================================================",
        "Now that the patient is suspected to have an allergy, we refer them to ",
        "an allergist for specialized treatment.",

        "The following can prompt a visit to the allergist: ",
        "- Asthma attack ",
        "- Moderate to severe eczema ",
        "- Any allergic reaction to food ",
        "- Moderate to severe allergic rhinitis symptoms ",

        "The asthma, eczema, and allergic rhinitis submodules set the 'visit_allergist' ",
        "attribute to trigger the visit. At the first visit to an allergist an ",
        "allergy panel is always performed."
      ],
      "allow": {
        "condition_type": "Attribute",
        "attribute": "visit_allergist",
        "operator": "is not nil"
      },
      "direct_transition": "Delay_For_Allergist_Initial_Visit"
    },

    "Delay_For_Allergist_Initial_Visit": {
      "type": "Delay",
      "remarks": [
        "Other modules are not expected to make this delay after making a ",
        "'visit_allergist' recommendation."
      ],
      "range": {
        "low": 1,
        "high": 7,
        "unit": "days"
      },
      "direct_transition": "Allergist_Initial_Visit"
    },

    "Allergist_Initial_Visit": {
      "type": "Encounter",
      "remarks": [
        "This is the big one! Whatever allergies a patient has will be formally ",
        "diagnosed at this encounter."
      ],
      "encounter_class": "ambulatory",
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "185347001",
          "display": "Encounter for problem"
        }
      ],
      "conditional_transition": [
        {
          "condition": {
            "condition_type": "Date",
            "operator": ">",
            "year": 1974
          },
          "transition": "Administer_Allergy_Test"
        },
        {
          "transition": "General_Allergy_CarePlan"
        }
      ]
    },

    "Administer_Allergy_Test": {
      "type": "Procedure",
      "duration": {
        "low": 20,
        "high": 40,
        "unit": "minutes"
      },
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "395142003",
          "display": "Allergy screening test"
        }
      ],
      "direct_transition": "Allergy_Panel"
    },

    "Allergy_Panel": {
      "type": "CallSubmodule",
      "submodule": "allergies/allergy_panel",
      "direct_transition": "General_Allergy_CarePlan"
    },

    "General_Allergy_CarePlan": {
      "type": "CarePlanStart",
      "remarks": [
        "Allergy maintenance is all about self care."
      ],
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "326051000000105",
          "display": "Self care"
        }
      ],
      "activities": [
        {
          "system": "SNOMED-CT",
          "code": "58332002",
          "display": "Allergy education"
        }
      ],
      "conditional_transition": [
        {
          "condition": {
            "condition_type": "Date",
            "operator": ">=",
            "year": 1987
          },
          "transition": "Prescribe_Epipen"
        },
        {
          "transition": "End_Allergist_Initial_Visit"
        }
      ]
    },

    "Prescribe_Epipen": {
      "type": "MedicationOrder",
      "remarks": [
        "FDA approved in 1987. It's highly likely that this prescription ",
        "will never end - it will just be periodically renewed during the ",
        "patient's lifetime."
      ],
      "codes": [
        {
          "system": "RxNorm",
          "code": "727316",
          "display": "0.3 ML EPINEPHrine 0.5 MG/ML Auto-Injector"
        }
      ],
      "prescription": {
        "as_needed": true
      },
      "direct_transition": "End_Allergist_Initial_Visit"
    },

    "End_Allergist_Initial_Visit": {
      "type": "EncounterEnd",
      "direct_transition": "Living_With_Allergies"
    },

    "Living_With_Allergies": {
      "type": "Simple",
      "remarks": [
        "======================================================================",
        " LIVING WITH ALLERGIES                                                ",
        "======================================================================",
        "Whatever allergies the patients have they will continue to passively ",
        "live with them until an allergic condition or a severe reaction ",
        "prompts a visit to their PCP and a referral to an allergist. Allergies ",
        "aren't officially diagnosed until after an allergy test is performed."
      ],
      "conditional_transition": [
        {
          "remarks": [
            "For patient's 12 or older we can consider immunotherapy. This will ",
            "not work for everyone but it's worth discussing. Immunotherapy is not ",
            "an option before 1990."
          ],
          "condition": {
            "condition_type": "And",
            "conditions": [
              {
                "condition_type": "Age",
                "operator": ">",
                "quantity": 12,
                "unit": "years"
              },
              {
                "condition_type": "Date",
                "operator": ">=",
                "year": 1990
              },
              {
                "condition_type": "Attribute",
                "attribute": "immunotherapy_status",
                "operator": "is nil"
              }
            ]
          },
          "transition": "Immunotherapy_Consultation"
        },
        {
          "transition": "Living_With_Allergies"
        }
      ]
    },

    "Immunotherapy_Consultation": {
      "type": "Encounter",
      "remarks": [
        "======================================================================",
        " IMMUNOTHERAPY                                                        ",
        "======================================================================",
        "Allergen immunotherapy for hay fever has been common practice since the ",
        "1930's. It was first proven by scientists in the UK in 1911. It has since ",
        "been expanded to include additional environmental and food allergens."
      ],
      "encounter_class": "ambulatory",
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "170837001",
          "display": "Allergic disorder initial assessment"
        }
      ],
      "distributed_transition": [
        {
          "distribution": 0.75,
          "transition": "Immunotherapy_Given"
        },
        {
          "distribution": 0.25,
          "transition": "Immunotherapy_Not_Given",
          "remarks": [
            "The distribution here is somewhat arbitrary. I could not find reasonable stats for",
            "what percentage of people are given immunotherapy but it's not everyone.",
            "I went with a 75/25 split. Reasons to not give immunotherapy include fear of needles,",
            "pre-existing immune conditions (like AIDS), and prohibitive cost."
          ]
        }
      ]
    },

    "Immunotherapy_Given": {
      "type": "SetAttribute",
      "attribute": "immunotherapy_status",
      "value": "given",
      "direct_transition": "Immunotherapy_CarePlan"
    },

    "Immunotherapy_Not_Given": {
      "type": "SetAttribute",
      "attribute": "immunotherapy_status",
      "value": "not-given",
      "direct_transition": "End_Consultation"
    },

    "Immunotherapy_CarePlan": {
      "type": "CarePlanStart",
      "target_encounter": "Immunotherapy_Consultation",
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "170836005",
          "display": "Allergic disorder monitoring"
        }
      ],
      "activities": [
        {
          "system": "SNOMED-CT",
          "code": "764101000000108",
          "display": "Allergen immunotherapy drugs Band 1"
        }
      ],
      "direct_transition": "End_Consultation"
    },

    "End_Consultation" : {
      "type" : "EncounterEnd",
      "direct_transition" : "Initialize_Immunotherapy_Counter"
    },

    "Initialize_Immunotherapy_Counter": {
      "type": "SetAttribute",
      "attribute": "immunotherapy_counter",
      "value": 0,
      "direct_transition": "Undergoing_Immunotherapy_Treatment"
    },

    "Undergoing_Immunotherapy_Treatment": {
      "type": "Delay",
      "remarks": [
        "Patients get immunotherapy treatments for an average of 5 years.",
        "Given monthly appointments we count a total of 60 appointments before ",
        "ending the immunotherapy."
      ],
      "range": {
        "low": 3,
        "high": 4,
        "unit": "weeks"
      },
      "conditional_transition": [
        {
          "condition": {
            "condition_type": "Attribute",
            "attribute": "immunotherapy_counter",
            "operator": "<",
            "value": 60
          },
          "transition": "Immunotherapy_Treatment"
        },
        {
          "transition": "Immunotherapy_Treatment_Complete"
        }
      ]
    },

    "Immunotherapy_Treatment": {
      "type": "Encounter",
      "encounter_class": "ambulatory",
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "371883000",
          "display": "Outpatient procedure"
        }
      ],
      "direct_transition": "Immunotherapy_Procedure"
    },

    "Immunotherapy_Procedure": {
      "type": "Procedure",
      "target_encounter": "Immunotherapy_Treatment",
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "180256009",
          "display": "Subcutaneous immunotherapy"
        }
      ],
      "duration": {
        "low": 15,
        "high": 60,
        "unit": "minutes"
      },
      "direct_transition": "End_Treatment_Session"
    },

    "End_Treatment_Session" : {
      "type" : "EncounterEnd",
      "direct_transition": "Count_A_Treatment"
    },

    "Count_A_Treatment": {
      "type": "Counter",
      "action": "increment",
      "attribute": "immunotherapy_counter",
      "direct_transition": "Undergoing_Immunotherapy_Treatment"
    },

    "Immunotherapy_Treatment_Complete": {
      "type": "Simple",
      "direct_transition": "Immunotherapy_Followup"
    },

    "Immunotherapy_Followup": {
      "type": "Encounter",
      "encounter_class": "ambulatory",
      "codes": [
        {
          "system": "SNOMED-CT",
          "code": "170838006",
          "display": "Allergic disorder follow-up assessment"
        }
      ],
      "direct_transition": "Immunotherapy_CarePlan_Ends"
    },

    "Immunotherapy_CarePlan_Ends": {
      "type": "CarePlanEnd",
      "careplan": "Immunotherapy_CarePlan",
      "direct_transition": "Followup_End"
    },

    "Followup_End" : {
      "type" : "EncounterEnd",
      "direct_transition": "Living_With_Allergies"
    },

    "Terminal": {
      "type": "Terminal"
    }
  }
}
